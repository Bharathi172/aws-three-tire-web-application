#!/bin/bash
# Three-Tier Application - Amazon Linux 2023 - PRODUCTION READY
# ----------------------------
# Database connection details
# ----------------------------
DB_ENDPOINT="your-rds-endpoint.region.rds.amazonaws.com"
DB_NAME="guestbook"
DB_USER="admin"
DB_PASSWORD="your-secure-password"

# ----------------------------
# Logging function
# ----------------------------
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/webapp-setup.log
}

log "Starting web server setup..."

# ----------------------------
# Configure IMDSv2 for metadata access
# ----------------------------
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null)

# ----------------------------
# Update system and install packages
# ----------------------------
log "Updating system..."
dnf update -y

log "Installing Apache, PHP, MySQL client..."
dnf install -y httpd php php-mysqlnd mariadb105

if [ $? -ne 0 ]; then
    log "ERROR: Failed to install packages"
    exit 1
fi

# ----------------------------
# Start and enable Apache
# ----------------------------
log "Starting Apache..."
systemctl enable httpd
systemctl start httpd

# ----------------------------
# Get instance metadata
# ----------------------------
if [ -n "$TOKEN" ]; then
    INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-id)
    AZ=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
    PRIVATE_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/local-ipv4)
else
    INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
    AZ=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
    PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
fi

log "Instance: $INSTANCE_ID in $AZ at $PRIVATE_IP"

# ----------------------------
# Wait for database
# ----------------------------
log "Waiting for database..."
sleep 30

# ----------------------------
# Test and create database table
# ----------------------------
log "Testing database connection..."
mysql -h "$DB_ENDPOINT" -u "$DB_USER" -p"$DB_PASSWORD" -e "SELECT 1;" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    log "‚úÖ Database connected"
    mysql -h "$DB_ENDPOINT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" << 'SQLEOF'
CREATE TABLE IF NOT EXISTS messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    message TEXT NOT NULL,
    ip_address VARCHAR(45),
    instance_id VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
SQLEOF
    log "‚úÖ Database table ready"
else
    log "‚ö†Ô∏è Database connection failed"
fi

# ----------------------------
# Create health check endpoint
# ----------------------------
cat > /var/www/html/health.html << 'EOF'
OK
EOF

# ----------------------------
# Create PHP application
# ----------------------------
cat > /var/www/html/index.php << 'PHPEOF'
<?php
$db_host = 'your-rds-endpoint.region.rds.amazonaws.com';
$db_name = 'guestbook';
$db_user = 'admin';
$db_pass = 'your-secure-password';

// Get instance metadata using IMDSv2
$token = @file_get_contents('http://169.254.169.254/latest/api/token', false, stream_context_create([
    'http' => ['method' => 'PUT', 'header' => 'X-aws-ec2-metadata-token-ttl-seconds: 21600']
]));
$context = stream_context_create(['http' => ['header' => "X-aws-ec2-metadata-token: $token"]]);
$instance_id = @file_get_contents('http://169.254.169.254/latest/meta-data/instance-id', false, $context) ?: 'unknown';
$az = @file_get_contents('http://169.254.169.254/latest/meta-data/placement/availability-zone', false, $context) ?: 'unknown';

// Connect to database
$conn = new mysqli($db_host, $db_user, $db_pass, $db_name);
$db_status = $conn->connect_error ? 'Disconnected' : 'Connected';

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !$conn->connect_error) {
    $name = $conn->real_escape_string($_POST['name'] ?? '');
    $message = $conn->real_escape_string($_POST['message'] ?? '');
    $ip = $_SERVER['REMOTE_ADDR'];
    $sql = "INSERT INTO messages (name, message, ip_address, instance_id) VALUES ('$name', '$message', '$ip', '$instance_id')";
    $conn->query($sql);
}

// Fetch recent messages
$messages = [];
if (!$conn->connect_error) {
    $result = $conn->query("SELECT * FROM messages ORDER BY created_at DESC LIMIT 10");
    if ($result) $messages = $result->fetch_all(MYSQLI_ASSOC);
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Three-Tier Guestbook</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; text-align: center; }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .status-label { font-weight: 600; color: #555; }
        .status-connected { color: #10b981; font-weight: 600; }
        .status-failed { color: #ef4444; font-weight: 600; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 5px; margin: 10px 0; font-size: 16px; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .message { background: #f9fafb; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea; }
        .message-name { font-weight: 600; color: #667eea; }
        .message-meta { font-size: 12px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Three-Tier Guestbook</h1>
        </div>
        <div class="box">
            <h3>üìä Server Status</h3>
            <div class="status-item">
                <span class="status-label">Instance:</span>
                <span><?php echo htmlspecialchars($instance_id); ?></span>
            </div>
            <div class="status-item">
                <span class="status-label">Availability Zone:</span>
                <span><?php echo htmlspecialchars($az); ?></span>
            </div>
            <div class="status-item">
                <span class="status-label">Database:</span>
                <span class="<?php echo $conn->connect_error ? 'status-failed' : 'status-connected'; ?>">
                    <?php echo $db_status; ?>
                </span>
            </div>
        </div>
        <?php if (!$conn->connect_error): ?>
        <div class="box">
            <h3>‚úçÔ∏è Leave a Message</h3>
            <form method="POST">
                <input type="text" name="name" placeholder="Your Name" required>
                <textarea name="message" placeholder="Your Message" rows="4" required></textarea>
                <button type="submit">Submit</button>
            </form>
        </div>
        <div class="box">
            <h3>üí¨ Recent Messages</h3>
            <?php foreach ($messages as $msg): ?>
            <div class="message">
                <div class="message-name"><?php echo htmlspecialchars($msg['name']); ?></div>
                <div><?php echo nl2br(htmlspecialchars($msg['message'])); ?></div>
                <div class="message-meta">Instance: <?php echo htmlspecialchars($msg['instance_id']); ?> | <?php echo $msg['created_at']; ?></div>
            </div>
            <?php endforeach; ?>
            <?php if (empty($messages)): ?>
            <p style="text-align: center; color: #999; padding: 20px;">No messages yet. Be the first!</p>
            <?php endif; ?>
        </div>
        <?php endif; ?>
    </div>
</body>
</html>
<?php if (!$conn->connect_error) $conn->close(); ?>
PHPEOF

# ----------------------------
# Set permissions
# ----------------------------
chown -R apache:apache /var/www/html
chmod -R 755 /var/www/html

# ----------------------------
# Restart Apache
# ----------------------------
systemctl restart httpd
sleep 2

# ----------------------------
# Verify setup
# ----------------------------
if systemctl is-active --quiet httpd; then
    log "‚úÖ Apache running"
else
    log "‚ùå Apache failed"
fi

if curl -s http://localhost/health.html | grep -q "OK"; then
    log "‚úÖ Health check OK"
else
    log "‚ùå Health check failed"
fi

log "Setup complete!"
echo "SUCCESS" > /var/log/webapp-complete
